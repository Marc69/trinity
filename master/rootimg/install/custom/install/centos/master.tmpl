#
#cmdline

lang en_US
#KICKSTARTNET#

#
# Where's the source?
# nfs --server hostname.of.server or IP --dir /path/to/RH/CD/image
#
#nfs --server #XCATVAR:INSTALL_NFS# --dir #XCATVAR:INSTALL_SRC_DIR#

#repo --name=base --baseurl=http://mirror.cogentco.com/pub/linux/centos/7/os/x86_64/
#url --url="http://mirror.cogentco.com/pub/linux/centos/7/os/x86_64/"

# HTH: our own repos do not work. Apparently just doing copycds does not create a proper repository.
# %include /tmp/repos

repo --name=base --baseurl=http://master/install/centos7.0/x86_64/
url --url="http://master/install/centos7.0/x86_64/"

repo --name=xcat-core --baseurl=https://sourceforge.net/projects/xcat/files/yum/2.8/xcat-core
repo --name=xcat-dep --baseurl=https://sourceforge.net/projects/xcat/files/yum/xcat-dep/rh7/x86_64 
repo --name=epel --mirrorlist=https://mirrors.fedoraproject.org/metalink?repo=epel-7&arch=x86_64

#device ethernet e100
keyboard "us"

#
# Clear the MBR
#
zerombr

#
# Wipe out the disk
#
clearpart --all --initlabel
#clearpart --linux
#key --skip

#
# Customize to fit your needs
#

#XCAT_PARTITION_START#
#No RAID
#/boot really significant for this sort of setup nowadays?
#part /boot --size 50 --fstype ext3
%include /tmp/partitioning
#part swap --size 1024 
#part / --size 1 --grow --fstype ext4
#XCAT_PARTITION_END#

# bootloader config
# --append <args>
# --useLilo
# --md5pass <crypted MD5 password for GRUB>
#
bootloader

#
# install or upgrade
#
install

#
# text mode install (default is graphical)
# HTH: changed text into cmdline
#text
cmdline

#
# firewall
#
firewall --disabled

#
# Select a zone
# Add the --utc switch if your hardware clock is set to GMT
#
#timezone US/Hawaii
#timezone US/Pacific
#timezone US/Mountain
#timezone US/Central
#timezone US/Eastern
timezone --utc "#TABLE:site:key=timezone:value#"

#
# Don't do X
#
skipx


#
# To generate an encrypted root password use:
#
# perl -e 'print crypt("blah","Xa") . "\n";'p
# openssl passwd -apr1 -salt xxxxxxxx password
# 
# where "blah" is your root password.
#
#rootpw --iscrypted XaLGAVe1C41x2
#rootpw XaLGAVe1C41x2 --iscrypted
rootpw --iscrypted #CRYPT:passwd:key=system,username=root:password#

#
# NIS setup: auth --enablenis --nisdomain sensenet 
# --nisserver neptune --useshadow --enablemd5
#
# OR
auth --useshadow --enablemd5


#
# SE Linux
#
selinux --disabled

#
# Reboot after installation
#
reboot
%include /tmp/trinity-networking

#
#end of section
#
%packages
#INCLUDE_DEFAULT_PKGLIST#
%end
%pre
#INCLUDE:#ENV:XCATROOT#/share/xcat/install/scripts/pre.rh.rhel7#

read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)

if [ -z $ETH3 ]; then
cat > /tmp/trinity-networking << EOF
network  --bootproto=static --device=$ETH2 --gateway=192.168.2.254 --ip=192.168.2.254 --netmask=255.255.255.0 --ipv6=auto --nodefroute --onboot=yes
network  --bootproto=dhcp --device=$ETH1 --ipv6=auto --onboot=yes
network  --hostname=newmaster.cluster
EOF
else
cat > /tmp/trinity-networking << EOF
network  --bootproto=static --device=$ETH2 --gateway=192.168.2.254 --ip=192.168.2.254 --netmask=255.255.255.0 --ipv6=auto --nodefroute --onboot=yes
network  --bootproto=static --device=$ETH2 --gateway=192.168.8.254 --ip=192.168.8.254 --netmask=255.255.255.0 --ipv6=auto --nodefroute --onboot=yes
network  --bootproto=dhcp --device=$ETH1 --ipv6=auto --onboot=yes
network  --hostname=newmaster.cluster
EOF
fi

%end
%post
exec < /dev/console > /dev/console
#INCLUDE:#ENV:XCATROOT#/share/xcat/install/scripts/post.xcat#

# setup the correct network names
read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)

echo setup nat
# setup NAT, so nodes can access the internet (see manual step 1.f)
chkconfig iptables on
service iptables start
modprobe iptable_nat
iptables -A FORWARD -i $ETH2 -j ACCEPT
iptables -t nat -A POSTROUTING -o $ETH1 -j MASQUERADE
service iptables save 

echo install extra rpms
# Install required utilities and turn on ntp
chkconfig ntpd on
systemctl disable avahi-daemon

for file in /etc/sysconfig/network-scripts/ifcfg-{$ETH2,$ETH3}; do
    sed -i $file -e "s/DEFROUTE=\(.*\)/DEFROUTE=no/"
done
sed -i /etc/sysconfig/network-scripts/ifcfg-$ETH1 -e "s/DEFROUTE=\(.*\)/DEFROUTE=yes/" -e "s/PEERDNS=\(.*\)/PEERDNS=no/"

%end
