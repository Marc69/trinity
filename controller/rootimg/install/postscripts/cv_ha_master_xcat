# Add the extra configuration that needs to run only on the master nodes

# assign the floating IP address the master
# FIXME: find a better IP address
ip addr add 10.141.255.250/16 dev eth0

drbdadm primary --force ha_disk

mkfs -t ext4 /dev/drbd1
mkdir /drbd
mount /dev/drbd1 /drbd


# actually, this can be moved to a resource specific script
export XCATMYSQLADMIN_PW=system
export XCATMYSQLROOT_PW=system
mysqlsetup -i

makedhcp -n
makedns -n

# FIXME: this should be part of the specific HA scripts

rm /etc/httpd/logs ; ln -s /var/log/httpd /etc/httpd/logs
rm /etc/httpd/modules ; ln -s /usr/lib64/httpd/modules /etc/httpd/modules
rm /etc/httpd/run ; ln -s /var/run/httpd /etc/httpd/run

cat <<EOF > /drbd/xcat.conf
restartSyslog(1)
cleanthisconfig(1)

#  One mountpoint must be listed.  This is the location where the DRBD
#  drive is mounted.
mountpoint('/drbd')
# ==== xCAT ====
link('/install')
link('/etc/xcat')
link('/opt/xcat')
link('/root/.xcat')
# Hosts is a bit odd - may just want to rsync out...
link('/etc/hosts')
# ==== Conserver ====
link('/etc/conserver.cf')
# ==== DNS ====
link('/etc/named')
link('/etc/named.conf')
link('/etc/named.iscdlv.key')
link('/etc/named.rfc1912.zones')
link('/etc/named.root.key')
#link('/etc/rndc.conf')
#link('/etc/rndc.key')
link('/etc/sysconfig/named')
link('/var/named')
# ==== YUM ====
link('/etc/yum.repos.d')
# ==== DHCP ====
link('/etc/dhcp')
link('/var/lib/dhcpd')
link('/etc/sysconfig/dhcpd')
#link('/etc/sysconfig/dhcpd6')
#
# ==== Apache ====
link('/etc/httpd')
link('/var/www')
#
# ==== MySQL ====
link('/etc/my.cnf')
link('/var/lib/mysql')
#
# ==== tftp ====
link('/tftpboot')
#
# ==== NFS ====
link('/etc/exports')
link('/var/lib/nfs')
link('/etc/sysconfig/nfs')
#
EOF

drbdlinks -c /drbd/xcat.conf initialize_shared_storage
drbdlinks -c /drbd/xcat.conf start

#-------------------------------------------------------
# Basic cluster setup
#------------------------------------------------------- 
pcs cluster auth node001.cluster node002.cluster -u hacluster -p system 
pcs cluster setup --name xCAT node001.cluster node002.cluster
pcs cluster start --all

pcs property set no-quorum-policy=ignore
pcs resource op defaults timeout="120s"
pcs resource defaults resource-stickyness=100
pcs property set stonith-enabled=false

#-------------------------------------------------------
# Create resources
#-------------------------------------------------------
pcs resource create ip_xCAT ocf:heartbeat:IPaddr2 ip="10.141.255.250" iflabel="xCAT" cidr_netmask="16" nic="eth0" op monitor interval="37s" 

pcs resource create drbd ocf:linbit:drbd drbd_resource=ha_disk
pcs resource master ms_drbd drbd master-max="1" master-node-max="1" clone-max="2" clone-node-max="1" notify="true"
pcs resource create fs_drbd ocf:heartbeat:Filesystem device="/dev/drbd/by-res/ha_disk" directory="/drbd" fstype="ext4" op monitor interval="57s"
pcs resource create symlinks_xCAT ocf:tummy:drbdlinks configfile="/drbd/xcat.conf" op monitor interval="31s"

pcs resource create httpd systemd:httpd op monitor interval="37s"
pcs resource create mysqld systemd:mysqld op monitor interval="37s"
pcs resource create dhcpd systemd:dhcpd op monitor interval="37s"
pcs resource create named systemd:named op monitor interval="37s"
pcs resource create xCAT lsb:xcatd op monitor interval="42s"

# For convenience we create to groups of resources. 
# This will help ordering according to the dependencies.
pcs resource group add grp_drbd fs_drbd symlinks_xCAT
pcs resource group add grp_xCAT httpd dhcpd named mysqld xCAT

# We specify that all services and groups should be on 
# the same node as where drbd keeps its master copy of the data.
pcs constraint colocation add grp_xCAT grp_drbd
pcs constraint colocation add grp_drbd ms_drbd INFINITY with-rsc-role=Master
pcs constraint colocation add ip_xCAT ms_drbd INFINITY with-rsc-role=Master
pcs constraint colocation add grp_xCAT xCAT

# Finally we specify the order in which resources should be started.
pcs constraint order fs_drbd then start symlinks_xCAT
pcs constraint order ip_xCAT then start grp_drbd
pcs constraint order promote ms_drbd then start grp_drbd
pcs constraint order start grp_drbd then start grp_xCAT
pcs constraint order start grp_xCAT then start xCAT

echo "Done"
