rm /etc/httpd/logs ; ln -s /var/log/httpd /etc/httpd/logs
rm /etc/httpd/modules ; ln -s /usr/lib64/httpd/modules /etc/httpd/modules
rm /etc/httpd/run ; ln -s /var/run/httpd /etc/httpd/run

cat <<EOF > /drbd/xcat.conf

restartSyslog(1)
cleanthisconfig(1)

#  One mountpoint must be listed.  This is the location where the DRBD
#  drive is mounted.
mountpoint('/drbd')
# ==== xCAT ====
link('/install')
link('/etc/xcat')
link('/opt/xcat')
link('/root/.xcat')
# Hosts is a bit odd - may just want to rsync out...
#link('/etc/hosts')
#
# ==== Conserver ====
link('/etc/conserver.cf')
#
# ==== DNS ====
link('/etc/named')
link('/etc/named.conf')
link('/etc/named.iscdlv.key')
link('/etc/named.rfc1912.zones')
link('/etc/named.root.key')
#link('/etc/rndc.conf')
#link('/etc/rndc.key')
link('/etc/sysconfig/named')
link('/var/named')
# ==== YUM ====
link('/etc/yum.repos.d')
#
# ==== DHCP ====
link('/etc/dhcp')
link('/var/lib/dhcpd')
link('/etc/sysconfig/dhcpd')
#link('/etc/sysconfig/dhcpd6')
#
# ==== Apache ====
link('/etc/httpd')
link('/var/www')
#
# ==== tftp ====
link('/tftpboot')
#
# ==== openldap ====
link('/etc/openldap')
link('/var/lib/ldap')
#
# ==== docker registry ====
link('/var/lib/docker-registry')

# ==== NFS ====
link('/etc/exports')
link('/var/lib/nfs')
link('/etc/sysconfig/nfs')
#
# === Trinity NFS shares ====
link('/trinity/')
link('/cluster/')
link('/home')
#
EOF

systemctl stop xcatd
systemctl stop docker-registry
systemctl stop nfs-server

drbdlinks -c /drbd/xcat.conf initialize_shared_storage
drbdlinks -c /drbd/xcat.conf start
systemctl start xcatd
systemctl start docker
systemctl start docker-registry
systemctl start nfs-server

#-------------------------------------------------------------------
# Now setup the common resources
#-------------------------------------------------------------------
dev=$(ip a | grep 10.148.255.253 | awk '{print $5}')

pcs resource create symlinks_xCAT ocf:tummy:drbdlinks configfile="/drbd/xcat.conf" op monitor interval="31s"

pcs resource create httpd systemd:httpd op monitor interval="37s"
pcs resource create dhcpd systemd:dhcpd op monitor interval="37s"
pcs resource create named systemd:named op monitor interval="37s"
pcs resource create nfs nfsserver nfs_no_notify=true op start timeout=240s
pcs resource create docker-registry systemd:docker-registry op monitor interval="37s"
pcs resource create slapd systemd:slapd op monitor interval="37s"
pcs resource create xCAT lsb:xcatd op monitor interval="42s"

   #pcs resource create keystone systemd:keystone op monitor interval="34s"
   #pcs resource create glance systemd:glance op monitor interval="34s"
   #pcs resource create nova_controller systemd:nova_controller op monitor interval="34s"
   #pcs resource create omd systemd:omd op monitor interval="34s"

   # For named cloning to work we need to change /etc/resolv.conf as well.
pcs resource clone named clone-max=2 clone-node-max=1 notify=false

   #pcs resource group add grp_dependent_containers keystone glance nova_controller omd
pcs resource group add grp_xCAT httpd dhcpd named nfs docker-registry slapd xCAT
pcs constraint colocation add fs_drbd symlinks_xCAT
pcs constraint colocation add fs_drbd grp_xCAT

pcs constraint order fs_drbd then start symlinks_xCAT
pcs constraint order symlinks_xCAT then start grp_xCAT

# Finally some defaults
pcs property set no-quorum-policy=ignore
pcs resource op defaults timeout="120s"
pcs resource defaults resource-stickyness=100
pcs property set stonith-enabled=false

systemctl enable pacemaker
systemctl enable corosync

echo "$0 finished @ $(date)" >> /var/log/postinstall.log
