#
#cmdline

lang en_US
#KICKSTARTNET#

%include /tmp/repos

keyboard "us"

#
# Clear the MBR
#
zerombr

#
# Wipe out the disk
#
clearpart --all --initlabel

#
# Customize to fit your needs
#

#XCAT_PARTITION_START#
#No RAID
# %include /tmp/partitioning

part /boot --fstype ext3 --size=1024
part swap --size=2048
part pv.01 --size=1 --grow
volgroup vg_root pv.01
logvol  /  --vgname=vg_root  --size=65536  --name=lv_root
logvol  /tmp  --vgname=vg_root  --size=2048  --name=lv_tmp
logvol  /var  --vgname=vg_root  --size=8192  --name=lv_var
logvol  /drbd  --vgname=vg_root  --size=8192  --name=lv_drbd
logvol  /spare  --vgname=vg_root  --size=1 --grow  --name=lv_spare

#XCAT_PARTITION_END#

bootloader

#
# install or upgrade
#
install

#
# text mode install (default is graphical)
# HTH: changed text into cmdline
#text
cmdline

#
# firewall
#
firewall --disabled

#
# Select a zone
# Add the --utc switch if your hardware clock is set to GMT
#
timezone --utc "#TABLE:site:key=timezone:value#"

#
# Don't do X
#
skipx


#
# To generate an encrypted root password use:
#
# perl -e 'print crypt("blah","Xa") . "\n";'p
# openssl passwd -apr1 -salt xxxxxxxx password
# 
# where "blah" is your root password.
#
rootpw --iscrypted #CRYPT:passwd:key=system,username=root:password#

#
# NIS setup: auth --enablenis --nisdomain sensenet 
# --nisserver neptune --useshadow --enablemd5
#
# OR
auth --useshadow --enablemd5


#
# SE Linux
#
selinux --disabled

#
# Reboot after installation
#
reboot
%include /tmp/trinity-networking

#
#end of section
#
%packages
#INCLUDE_DEFAULT_PKGLIST#
%end
%pre
#INCLUDE:#ENV:XCATROOT#/share/xcat/install/scripts/pre.rh.rhel7#

read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)
if ping -c 1 -w 5 10.141.255.254; then
    # I must be the passive controller
    my_ip=10.141.255.252                                       
    my_hostname=controller-2.cluster
elif ping -c 1 -w 5 10.141.255.253; then
    # I must be the passive controller
    my_ip=10.141.255.252                                       
    my_hostname=controller-2.cluster
else
    # I can be either the only controller or I can be the active controller
    # I will assume for now that I am the only controller,
    # the cv_ha_master_xcat script will change hostnames and setup the floating ip address
    my_ip=10.141.255.254                                       # use a different fixed ip address
    my_hostname=controller.cluster
fi

cat > /tmp/trinity-networking << EOF
network  --bootproto=static --device=$ETH2 --gateway=10.141.255.254 --ip=$my_ip --netmask=255.255.0.0 --ipv6=auto --nodefroute --onboot=yes --nameserver=8.8.8.8
network  --bootproto=dhcp --device=$ETH1 --ipv6=auto --onboot=yes
network  --hostname=$my_hostname
EOF

%end
%post
exec < /dev/console > /dev/console
#INCLUDE:#ENV:XCATROOT#/share/xcat/install/scripts/post.xcat#

echo setup nat
read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)

echo install extra rpms
# Install required utilities and turn on ntp
yum -y install createrepo net-snmp-utils bind-utils wget ntp
chkconfig ntpd on
systemctl disable avahi-daemon

echo install xcat repositories
#wget --no-check-certificate #COMMAND:cat /etc/yum.repos.d/xCAT-core.repo | grep baseurl | awk -F= '{print $2}'#/xCAT-core.repo -O /etc/yum.repos.d/xCAT-core.repo
#wget --no-check-certificate #COMMAND:cat /etc/yum.repos.d/xCAT-dep.repo | grep baseurl | awk -F= '{print $2}'#/xCAT-dep.repo -O /etc/yum.repos.d/xCAT-dep.repo

# TODO:
# we need to download and install the trinity patches (which we basically need to copy from the benchmark/master node

for file in /etc/sysconfig/network-scripts/ifcfg-{$ETH2,$ETH3}; do
    #cat $file > /var/log/$(basename $file);
    #echo "adapting $file" >> /var/log/postinstall.log
    sed -i $file -e "s/DEFROUTE=\(.*\)/DEFROUTE=no/"
done
sed -i /etc/sysconfig/network-scripts/ifcfg-$ETH1 -e "s/DEFROUTE=\(.*\)/DEFROUTE=yes/" -e "s/PEERDNS=\(.*\)/PEERDNS=no/"

# Fix for #85
cat >> /etc/sysconfig/network-scripts/ifcfg-$ETH2 << EOF
IPADDR1=10.148.255.254
PREFIX1=16
GATEWAY1=10.148.255.254
EOF

echo done
%end
