# Setup high availability for the docker containers
pcs resource create docker systemd:docker op monitor interval="37s"
pcs resource clone docker clone-node-max=1 notify=false

pcs resource create mariadb systemd:mariadb op monitor interval="37s"
pcs resource create rabbitmq systemd:rabbitmq op monitor interval="37s"
pcs resource create keystone systemd:keystone op monitor interval="37s"
pcs resource create glance systemd:glance op monitor interval="37s"
pcs resource create nova-controller systemd:nova-controller op monitor interval="37s"

pcs resource group add grp_OpenStack mariadb rabbitmq keystone glance nova-controller
pcs constraint colocation add ip grp_OpenStack
pcs constraint order start grp_OpenStack then start sentinel
pcs constraint order start fs_drbd then start mariadb
pcs constraint order start mariadb then start xCAT
pcs constraint order start mariadb then start keystone
pcs constraint order start keystone then start glance
pcs constraint order start keystone then start nova-controller

#--------------------------------------------------------------------------
# Create keystone endpoints for glance etc
#--------------------------------------------------------------------------
keystone_endpoint="http://controller.cluster:35357/v2.0"
for i in {1..10}; do
    if curl -s ${keystone_endpoint}; then 
        /tmp/trinity/keystone/keystone-setup.sh
        /tmp/trinity/keystone/glance-setup.sh
        /tmp/trinity/keystone/nova-setup.sh
        echo "Applied keystone initialization scripts"
        break
    fi
    echo "Waiting for keystone to come up!"
    sleep 5
done

echo > /root/keystonerc_admin << EOF
export OS_USERNAME=admin
export OS_TENANT_NAME=admin
export OS_PASSWORD=system
export OS_AUTH_URL=http://controller.cluster:5000/v2.0/
export OS_REGION_NAME=regionOne
export PS1='[\u@\h \W(keystone_admin)]\$ '
EOF


echo "$0 finished @ $(date)" >> /var/log/postinstall.log
