#! /usr/bin/bash
##title          : cv_install_controller
##description    : Installs an xCAT controller node. Additionally it also configures
##                 the xCAT web service 
##author         : Hans Then & Abhishek Mukherjee
##email          : hans.then@clustervision
##                 abhishek.mukherjee@clustervision.com

systemctl stop NetworkManager
systemctl disable NetworkManager
killall dhclient
# disable the dhcp based ntp
rm /etc/dhcp/dhclient.d/ntp.sh
systemctl restart network
systemctl disable firewalld

# Prepare mounts, so we can copy stuffs from master
mkdir /tmp/trinity
mount ${SITEMASTER}:/trinity /tmp/trinity
mkdir -p /trinity


read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)
# setup NAT, so nodes can access the internet (see manual step 1.f)
# FIXME: maybe move iptables save output to the rootimg profile.
chkconfig iptables on
service iptables start
modprobe iptable_nat
iptables -A FORWARD -i $ETH2 -j ACCEPT
iptables -t nat -A POSTROUTING -o $ETH1 -j MASQUERADE
iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited
iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited
service iptables save

#--------------------------------------------------------------------------------------
# copy required files from the master node to the controller node
#--------------------------------------------------------------------------------------
cp -LrT /tmp/trinity/clustervision /trinity &
cp -LrT /tmp/trinity/controller/rootimg /
cp /tmp/trinity/version /trinity/version
cp /tmp/trinity/site /trinity/site

# FIXME (this should be moved out of the rootimg)
cat > /etc/resolv.conf << EOF
domain cluster
search cluster
nameserver 10.1.101.101
EOF

#--------------------------------------------------------------------------------------
# setup routing for the virtual clusters
#--------------------------------------------------------------------------------------
ip route add 172.16.0.0/12 dev $ETH2
mv /etc/sysconfig/network-scripts/route-eno2 /etc/sysconfig/network-scripts/route-${ETH2} 2> /dev/null

#--------------------------------------------------------------------------------------
# Additional network processing
#--------------------------------------------------------------------------------------
# remove the default route from other devices
for file in /etc/sysconfig/network-scripts/ifcfg-{$ETH2,$ETH3}; do
    sed -i $file -e "s/DEFROUTE=\(.*\)/DEFROUTE=no/"
done

# disable peerdns
sed -i /etc/sysconfig/network-scripts/ifcfg-$ETH1 -e "s/DEFROUTE=\(.*\)/DEFROUTE=yes/" -e "s/PEERDNS=\(.*\)/PEERDNS=no/"

# Fix for #85
cat >> /etc/sysconfig/network-scripts/ifcfg-$ETH2 << EOF
IPADDR1=10.148.255.254
PREFIX1=16
GATEWAY1=10.148.255.254
EOF
ip a a 10.148.255.254/16 dev $ETH2

systemctl restart network
systemctl enable ntpd
systemctl start ntpd

#--------------------------------------------------------------------------------------
# Start opensm on the controller
#--------------------------------------------------------------------------------------
yum -y groupinstall "Infiniband Support"
yum -y install opensm
yum -y install infiniband-diags

systemctl enable opensm
systemctl start opensm

#--------------------------------------------------------------------------------------
# now setup NFS exports
#--------------------------------------------------------------------------------------
systemctl enable nfs-server
systemctl start nfs-server
exportfs -a

#-------------------------------------------------------------------------------------
# Setup the xCAT client code
#-------------------------------------------------------------------------------------
if ! grep XCATHOST /etc/profile.d/xcat.sh; then
    echo export XCATHOST=10.141.255.254:3001 >> /etc/profile.d/xcat.sh
fi
source /etc/profile.d/xcat.sh

#--------------------------------------------------------------------------------------
# install docker and docker-registry
# and create the trinity image for the compute nodes
#--------------------------------------------------------------------------------------
yum -y install docker docker-registry
#FIXME
echo "10.141.255.254 controller" >> /etc/hosts

# FIXME: move this to the rootimg profile
sed -i 's/REGISTRY_PORT=.*/REGISTRY_PORT=5050/' /etc/sysconfig/docker-registry
# FIXME: this is not idempotent
sed -i 's/OPTIONS=\(.*\)/OPTIONS=--insecure-registry controller:5050 --bip=10.146.255.254\/16 --fixed-cidr=10.146.255.255\/16 \1/' /etc/sysconfig/docker

systemctl enable docker docker-registry
systemctl start docker docker-registry
docker build -t controller:5050/trinity /trinity/container
docker push controller:5050/trinity

#-------------------------------------------------------------------------------------
# Build the xCAT container
#-------------------------------------------------------------------------------------
docker build -t controller:5050/xcat /trinity/xcat-container
docker push controller:5050/xcat
docker run -d --privileged --net=host --name xcat controller:5050/xcat
docker cp xcat:/install /
sleep 2
docker stop xcat
sleep 5
docker rm xcat
docker run -d --privileged --net=host -v /trinity:/trinity -v /install:/install --name xcat controller:5050/xcat

device=$(docker exec xcat losetup -f)
n=${device#/dev/loop}
docker exec xcat mknod "$device" b 7 "$n"
echo docker exec xcat mknod "$device" b 7 "$n"

# Export the keys, so we can access the commands as root.
docker cp xcat:/root/.xcat /root

#-------------------------------------------------------------------------------------
# Do copy cds
#-------------------------------------------------------------------------------------
cp -LrT /tmp/trinity/iso /trinity/iso
copycds -n centos7 -o /trinity/iso/*.iso

mkdir -p /trinity/xcattables
for table in $(ls /tmp/trinity/controller/xcat/tables); do
    sed -e "s/\<eno1\>/$ETH1/g" -e "s/\<eno2\>/$ETH2/g"  -e "s/\<eno3\>/$ETH3/g" /tmp/trinity/controller/xcat/tables/$table \
       > /trinity/xcattables/$table;
done

docker exec xcat restorexCATdb -p /trinity/xcattables



#--------------------------------------------
# Initialize the git repository
#--------------------------------------------
version=$(cat /trinity/version | head -2)
cd /
mv gitignore .gitignore
git init > /dev/null
git add . > /dev/null
git commit -m "Initial system setup based on Trinity: ${version//\*/}"

echo "$0 finished" >> /var/log/postinstall.log
