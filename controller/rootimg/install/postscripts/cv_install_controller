#!/bin/bash

#--------------------------------------------------------------------------------------
# install xcat
#--------------------------------------------------------------------------------------
# determine if a master is used to install this node:
if ping -c 4 -w 10 testme; then
    echo master is present
    mkdir /tmp/trinity
    mount master:/trinity /tmp/trinity       
    echo "Creating installation tree"
    copycds -o -n centos7.0 /tmp/trinity/iso/$(ls -cr /tmp/trinity/iso/*.iso | head -1)

    mkdir -p /install/post/otherpkgs/centos7.0/x86_64
    reposync -n -r xcat-otherpkgs0 -p /install/post/otherpkgs/centos7.0/x86_64/
    createrepo /install/post/otherpkgs/centos7.0/x86_64/
else
    echo No master found, checking for a git repository.
    SCRIPT=$(readlink -f $0)
    SCRIPTDIR=$(dirname $SCRIPT)
    REPODIR=$(readlink -f $SCRIPTDIR/../../../../)
    echo Found repository in $REPODIR
    # Do some sanity checks
    if git --work-tree=$REPODIR branch | grep r3; then
        cp -Lrv --preserve $REPODIR /tmp
        mkdir -p /tmp/trinity/iso
        echo Downloading cd, this may take a while
        wget http://ftp.nluug.nl/ftp/pub/os/Linux/distr/CentOS/7/isos/x86_64/CentOS-7-x86_64-DVD-1503-01.iso \
             -O /tmp/trinity/iso/CentOS-7-x86_64-DVD-1503-01.iso

	echo "Creating installation tree"
	copycds -o -n centos7.0 /tmp/trinity/iso/$(ls -cr /tmp/trinity/iso/*.iso | head -1)

        # setup repositories
        yum -y install epel-release
        yum -y install https://repos.fedorapeople.org/repos/openstack/openstack-juno/rdo-release-juno-1.noarch.rpm
        wget --no-check-certificate http://sourceforge.net/projects/xcat/files/yum/2.8/xcat-core/xCAT-core.repo -O /etc/yum.repos.d/xCAT-core.repo
        wget --no-check-certificate http://sourceforge.net/projects/xcat/files/yum/xcat-dep/rh7/x86_64/xCAT-dep.repo -O /etc/yum.repos.d/xCAT-dep.repo

        # now create a local repository
	mkdir -p /install/post/otherpkgs/centos7.0/x86_64
        reposync -n -r epel -r extras -r updates -r xcat-2-core -r xcat-dep -r openstack-juno -p /install/post/otherpkgs/centos7.0/x86_64/
	createrepo /install/post/otherpkgs/centos7.0/x86_64/
    else
        echo $REPODIR does not seem to be a valid repository. Bailing.
        exit 1
    fi
fi

#exit 0   # HTH remove this line after testing

mkdir /trinity

# copy all required module files etc to the right locations
# note to self: only /trinity/env needs be mounted inside the container
# FIXME: this takes an awful amount of time
cp -r /tmp/trinity/clustervision /trinity &

#--------------------------------------------------------------------------------------
# copy required files from the master node to the controller node
#--------------------------------------------------------------------------------------
cp -r /tmp/trinity/controller/rootimg/* / 
cp /tmp/trinity/version /trinity/version

#--------------------------------------------------------------------------------------
# create runimages
#--------------------------------------------------------------------------------------
for file in $(ls /install/runimages); do
    if [ -d /install/runimages/${file} ]; then 
        tar czf /install/runimages/${file}.tgz -C /install/runimages/${file}/ .
    fi
done

#--------------------------------------------------------------------------------------
# copy default database configuration
# copy the cd first, as otherwise copycds will overwrite the linuximage table
# and patch the installation
#--------------------------------------------------------------------------------------
source /etc/profile.d/xcat.sh
mkdir -p /tmp/xcattables
read ETH1 ETH2 ETH3 <<<$(ls /sys/class/net/ | grep "^e" | sort | head -3)
for table in $(ls /tmp/trinity/controller/xcat/tables); do
    sed -e "s/\<eno1\>/$ETH1/g" -e "s/\<eno2\>/$ETH2/g"  -e "s/\<eno3\>/$ETH3/g" /tmp/trinity/controller/xcat/tables/$table > /tmp/xcattables/$table;
done

restorexCATdb -p /tmp/xcattables  

# Fix for #149
ip addr a 10.141.255.254/16 dev $ETH2

# Now apply patches
cd /opt/xcat/share/xcat/netboot/centos

ln -s ../rh/dracut_033 .
ln -s ../rh/dracut .

cd /
cat /tmp/trinity/controller/xcat/patches/*.patch | patch -p0
systemctl restart xcatd
makedhcp -n
makehosts -n
makedns -n

#--------------------------------------------------------------------------------------
# correct any network settings
#--------------------------------------------------------------------------------------

# setup NAT, so nodes can access the internet (see manual step 1.f)
chkconfig iptables on
service iptables start
modprobe iptable_nat
iptables -A FORWARD -i $ETH2 -j ACCEPT
iptables -t nat -A POSTROUTING -o $ETH1 -j MASQUERADE
iptables -D FORWARD -j REJECT --reject-with icmp-host-prohibited
iptables -D INPUT -j REJECT --reject-with icmp-host-prohibited
service iptables save

#--------------------------------------------------------------------------------------
# setup routing for the virtual clusters
#--------------------------------------------------------------------------------------
ip route add 172.16.0.0/12 dev $ETH2
cat << END > /etc/sysconfig/network-scripts/route-$ETH2 
ADDRESS0=172.16.0.0
NETMASK0=255.240.0.0
END

#--------------------------------------------------------------------------------------
# Start opensm on the controller
#--------------------------------------------------------------------------------------
yum -y groupinstall "Infiniband Support"
yum -y install opensm
yum -y install infiniband-diags

systemctl enable opensm
systemctl start opensm

#--------------------------------------------------------------------------------------
# now setup NFS
#--------------------------------------------------------------------------------------
systemctl enable nfs-server
systemctl start nfs-server

cat << END > /etc/exports 
/tftpboot *(rw,no_root_squash,sync,no_subtree_check)
/install *(rw,no_root_squash,sync,no_subtree_check)
/trinity *(rw,sync,no_root_squash,no_all_squash)
/cluster *(rw,sync,no_root_squash,no_all_squash)
/home *(rw,sync,no_root_squash,no_all_squash)
END

exportfs -a

#--------------------------------------------------------------------------------------
# Selective updates
# Create installation tree
#--------------------------------------------------------------------------------------
echo "Creating installation tree"
copycds -o -n centos7.0 /tmp/trinity/iso/$(ls -cr /tmp/trinity/iso/*.iso | head -1)
mkdir -p /install/post/otherpkgs/centos7.0/x86_64

# I am not entirely sure about this
# 1. It will not work without master
# 2. It creates a different repo layout than is present on master
reposync -n -r xcat-otherpkgs0 -p /install/post/otherpkgs/centos7.0/x86_64/
createrepo /install/post/otherpkgs/centos7.0/x86_64/

# generate the image
genimage centos7.0-x86_64-netboot-trinity
packimage centos7.0-x86_64-netboot-trinity

#---------------------------------------------------------------------------------------
# Workaround: create a default munge key for vc-a cluster
#---------------------------------------------------------------------------------------
mkdir -p /cluster/vc-a/etc/munge/
dd if=/dev/urandom bs=1 count=1024 >/cluster/vc-a/etc/munge/munge.key
chmod 400 /cluster/vc-a/etc/munge/munge.key
chown 1002:1002 /cluster/vc-a/etc/munge/munge.key

#--------------------------------------------------------------------------------------
# install docker and docker-registry
# and create the trinity image for the compute nodes
#--------------------------------------------------------------------------------------
yum -y install docker docker-registry
sed -i 's/REGISTRY_PORT=.*/REGISTRY_PORT=5050/' /etc/sysconfig/docker-registry
sed -i 's/OPTIONS=\(.*\)/OPTIONS=--insecure-registry controller:5050 --bip=10.146.255.254/16 --fixed-cidr=10.146.255.255/16 \1/' /etc/sysconfig/docker
echo "10.141.255.254 controller" >>  /etc/hosts
systemctl enable docker docker-registry
systemctl start docker docker-registry
docker build -t controller:5050/trinity /trinity/compute
docker push controller:5050/trinity

echo $0 "finished" >> /var/log/postinstall.log
#--------------------------------------------------------------------------------------
# cleanup
#--------------------------------------------------------------------------------------

#umount /tmp/trinity
#rmdir /tmp/trinity

exit 0

